<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ game.name }} - Ã‰checs en ligne</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="game-container">
        <div class="game-info">
            <h1>{{ game.name }}</h1>
            {% if game.description %}
            <p class="game-description">{{ game.description }}</p>
            {% endif %}
            <div class="player-info">
                <div class="player white">
                    <h3>Blancs : {{ game.white_player.username }}</h3>
                </div>
                <div class="player black">
                    <h3>Noirs : {{ game.black_player.username }}</h3>
                </div>
            </div>
            <div class="game-status">
                <p>Votre couleur : <strong>{{ color|title }}</strong></p>
                <p>Adversaire : <strong>{{ opponent.username }}</strong></p>
            </div>
        </div>
        
        <div id="board" style="width: 600px"></div>
        
        <div class="game-controls">
            <button id="saluer">Dire bonjour</button>
            <button id="resign">Abandonner</button>
            <button id="draw">Proposer nulle</button>
            <div class="manual-move">
                <input type="text" id="moveInput" placeholder="Entrez un coup ex: e2e4" />
                <button id="playMove">Jouer</button>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function () {
        const game = new Chess();
        const board = Chessboard('board', {
            position: 'start',
            draggable: false,  // On dÃ©sactive drag&drop pour lâ€™instant
            orientation: '{{ color }}',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });

        const socket = io();
        window.socket = socket;
        const gameUuid = '{{ game.game_uuid }}';

        socket.on('connect', () => {
            console.log('âœ… ConnectÃ©');
            socket.emit('join_game', { game_uuid: gameUuid });
        });

        socket.on('game_state', function (data) {
            if (data.board_fen) {
                game.load(data.board_fen);
                board.position(data.board_fen, true); // ðŸ‘ˆ animation activÃ©e
            }

            // Attendre un court dÃ©lai pour laisser le temps Ã  l'animation
            if (data.is_game_over) {
                setTimeout(() => {
                    if (data.winner === 'draw') {
                        alert("Partie nulle !");
                    } else {
                        alert("Victoire des " + (data.winner === 'white' ? "Blancs" : "Noirs") + " !");
                    }
                }, 300); // 300ms â‰ˆ temps de lâ€™animation
            }
        });



        // âœ… Nouveau : gestion du champ de saisie de coup
       $('#playMove').click(function () {
        const moveInput = $('#moveInput').val().trim();

        if (moveInput.length < 4) {
            alert("Format invalide. Utilisez un format comme e2e4 ou e7e8q");
            return;
        }

        const move = {
            from: moveInput.slice(0, 2),
            to: moveInput.slice(2, 4),
            promotion: moveInput.length > 4 ? moveInput.slice(4) : undefined
        };

        const result = game.move(move);  // move local pour affichage

        if (result) {
            board.position(game.fen());
            socket.emit('make_move', {
                game_uuid: gameUuid,
                move: move.from + move.to + (move.promotion || '')
            });
            $('#moveInput').val('');
        } else {
            alert("Coup invalide.");
        }
    });


        // Autres Ã©vÃ©nements Ã©ventuels (nulle, abandon, etc.)
        socket.on('game_over', function (data) {
            alert('La partie est terminÃ©e : ' + data.result);
            window.location.href = '/games';
        });
    });
</script>



</body>
</html> 